---
title: "**Parallel Analysis Report**"
output: html_document
params:
  dumbbell_plot_path: NULL
  ri_plot_path: NULL
  density_plot_path: NULL
  single_density_plot_path: NULL
  box_plot_path: NULL
  summary_text: NULL
  individual_plots: list()
  individual_summaries: list()
  hemoglobin_value: "Value"
  unit: ""
  all_results: list()
---

<style>
body {
  font-family: Helvetica;
  line-height: 1.6;
}
h1, h2, h3 {
  color: #333;
}
pre {
  font-size: 9px !important;
  font-family: Helvetica, sans-serif !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
  background-color: #f5f5f5 !important;
  border: 1px solid #ddd !important;
  padding: 15px !important;
  border-radius: 5px !important;
}
@page {
  @bottom-right {
    content: "Page " counter(page) " of " counter(pages);
    font-size: 10px;
  }
}
</style>

##### *Analysis performed on `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`*

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 1:  A dumbbell plot visualizing the estimated reference intervals across different demographic subpopulations. The vertical axis categorizes each subpopulation, typically by gender and age range, while the horizontal axis represents the measured value. For each subpopulation, the two points mark the lower and upper bounds of the calculated reference interval, and the solid line connecting them represents the span of this range. The plot is often faceted by a primary demographic variable, such as gender, to allow for clear comparisons. Wider, semi-transparent bars behind each dumbbell, if shown, typically depict the 95% confidence intervals for the lower and upper bounds, providing a measure of the estimate's precision.</span>", out.width="60%"}
if (!is.null(params$dumbbell_plot_path) && file.exists(params$dumbbell_plot_path)) {
  knitr::include_graphics(params$dumbbell_plot_path)
} else {
  "Dumbbell plot not available."
}
```

```{r, echo=FALSE}
htmltools::HTML("<br>")
```

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 2: A plot illustrating how estimated reference intervals for a measured value vary across different age groups and genders. The vertical axis represents the scale of the measured value, while the horizontal axis represents age. For each demographic group, distinguished by color, the reference interval is depicted by a pair of horizontal lines: the lower line marks the 2.5th percentile (the lower reference limit), and the upper line marks the 97.5th percentile (the upper reference limit). The span of these lines along the x-axis indicates the specific age range to which each interval applies. Faintly shaded rectangular areas behind the lines, if present, represent the 95% confidence intervals for these limits, providing a measure of their statistical precision.", out.width="60%"}
if (!is.null(params$ri_plot_path) && file.exists(params$ri_plot_path)) {
  knitr::include_graphics(params$ri_plot_path)
} else {
  "RI plot not available."
}
```

```{r, echo=FALSE}
htmltools::HTML("<br>")
```

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 3: A faceted density plot illustrating the distribution of a measured value for multiple, distinct subpopulations. The plot is divided into several panels, where each panel is dedicated to a single subpopulation defined by demographic criteria such as gender and age range. Within each panel, the horizontal axis represents the scale of the measured value, while the vertical axis represents its probability density. The colored curve shows the smoothed distribution of the data for that group, and the two vertical dashed lines mark the estimated lower and upper limits of the 95% reference interval for that subpopulation.", out.width="60%"}
if (!is.null(params$density_plot_path) && file.exists(params$density_plot_path)) {
  knitr::include_graphics(params$density_plot_path)
} else {
  "Density plot not available."
}
```

```{r, echo=FALSE}
htmltools::HTML("<br>")
```

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 4: An overlaid density plot showing the value distributions for all subpopulations on a single set of axes. Each colored area represents a different subpopulation, allowing for direct comparison of their central tendency, spread, and overlap. The vertical dashed lines correspond to the lower and upper reference limits for their respective subpopulations.", out.width="60%"}
if (!is.null(params$single_density_plot_path) && file.exists(params$single_density_plot_path)) {
  knitr::include_graphics(params$single_density_plot_path)
} else {
  "Single density plot not available."
}
```

```{r, echo=FALSE}
htmltools::HTML("<br>")
```

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 5: A box plot summarizing the distribution of the measured value across various subpopulations. Each horizontal box-and-whisker corresponds to a specific demographic subpopulation, listed on the vertical axis, while the horizontal axis represents the scale of the measured value. The shaded box for each group represents the interquartile range (IQR), which contains the middle 50% of the data. The vertical line inside the box marks the median of the distribution. The lines, or 'whiskers,' extending from the box show the expected range of variation, and individual points beyond the whiskers are identified as potential outliers.", out.width="60%"}
if (!is.null(params$box_plot_path) && file.exists(params$box_plot_path)) {
  knitr::include_graphics(params$box_plot_path)
} else {
  "Box plot not available."
}
```

```{r, echo=FALSE}
htmltools::HTML("<br>")
```
<div style="page-break-before: always;"></div>

#### **Combined Summary**
```{r, results='asis', echo=FALSE}
if (!is.null(params$summary_text) && nzchar(params$summary_text)) {
  cat("```\n")
  cat(params$summary_text)
  cat("\n```")
} else {
  cat('Summary not available.')
}
```

```{r, echo=FALSE}
htmltools::HTML("<br>")
```
<div style="page-break-before: always;"></div>

### Individual Subpopulation Results
```{r, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
if (length(params$all_results) > 0) {
  for (i in seq_along(params$all_results)) {
    result <- params$all_results[[i]]
    if (result$status == "success") {
      
      # Extract RI data for the caption
      ri_data <- refineR::getRI(result$model)
      lower_limit <- round(ri_data$PointEst[1], 2)
      upper_limit <- round(ri_data$PointEst[2], 2)
      
      child_params <- list(
        plot_path = params$individual_plots[[i]],
        summary_text = params$individual_summaries[[i]],
        figure_number = i + 5,
        subpopulation_index = i,
        # --- Pass new parameters for dynamic caption ---
        hemoglobin_value = params$hemoglobin_value,
        unit = params$unit,
        gender = str_extract(result$label, "^\\w+"),
        age_min = result$age_min,
        age_max = result$age_max,
        model_name = result$final_model,
        lower_limit = lower_limit,
        upper_limit = upper_limit
      )
      cat(knitr::knit_child('template_parallel_child.Rmd', envir = list(params = child_params), quiet = TRUE))
    }
  }
} else {
  cat("No individual results were generated or available for the report.\n")
}