---
title: "**Parallel Analysis Report**"
output: html_document
params:
  dumbbell_plot_path: NULL
  ri_plot_path: NULL
  density_plot_path: NULL
  box_plot_path: NULL
  summary_text: NULL
  individual_plots: list()
  individual_summaries: list()
---

<style>
body {
  font-family: Helvetica;
  line-height: 1.6;
}
h1, h2, h3 {
  color: #333;
}
pre {
  font-size: 9px !important;
  font-family: Helvetica, sans-serif !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
  background-color: #f5f5f5 !important;
  border: 1px solid #ddd !important;
  padding: 15px !important;
  border-radius: 5px !important;
}
@page {
  @bottom-right {
    content: "Page " counter(page) " of " counter(pages);
    font-size: 10px;
  }
}
</style>

#### Analysis performed on `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`

---

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 1: A dumbbell plot showing the estimated reference intervals for each subpopulation. The points represent the lower and upper bounds of the reference intervals, and the lines connecting them represent the range. The wider, semi-transparent bars show the 95% confidence intervals for the lower and upper bounds.</span>", out.width="70%"}
if (!is.null(params$dumbbell_plot_path) && file.exists(params$dumbbell_plot_path)) {
  knitr::include_graphics(params$dumbbell_plot_path)
} else {
  "Dumbbell plot not available."
}

```{r, echo=FALSE}
htmltools::HTML("<br>")
```

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 2:.", out.width="70%"}">if (!is.null(params$ri_plot_path) && file.exists(params$ri_plot_path)) {
  knitr::include_graphics(params$ri_plot_path)
} else {
  "RI plot not available."
}

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 3:.", out.width="70%"}">if (!is.null(params$density_plot_path) && file.exists(params$density_plot_path)) {
  knitr::include_graphics(params$density_plot_path)
} else {
  "Density plot not available."
}

```{r, echo=FALSE, fig.cap="<span style='font-size: 0.7em;'>Figure 4:.", out.width="70%"}">if (!is.null(params$box_plot_path) && file.exists(params$box_plot_path)) {
  knitr::include_graphics(params$box_plot_path)
} else {
  "Box plot not available."
}

---

## Combined Summary

if (!is.null(params$summary_text) && nzchar(params$summary_text)) {
  cleaned_text <- gsub("## ?", "", params$summary_text)
  cat(paste0(cleaned_text))
} else {
  cat('<p>Summary not available.</p>')
}

## Individual Subpopulation Results

if (length(params$individual_plots) > 0) {
  for (i in seq_along(params$individual_plots)) {
    
    # Generate the plot with a dynamic caption
    plot_chunk <- paste0(
      "```{r, echo=FALSE, fig.cap=paste0(\"<span style='font-size: 0.7em;'>Figure ", i + 4, ": Estimated reference interval for subpopulation ", i, ".</span>\"), out.width='70%'}\n",
      "if (!is.null(params$individual_plots[[", i, "]]) && file.exists(params$individual_plots[[", i, "]])) {\n",
      "  knitr::include_graphics(params$individual_plots[[", i, "]])\n",
      "} else {\n",
      "  \"Subpopulation plot not available.\"\n",
      "}\n",
      "```"
    )
    cat(knitr::knit(text = plot_chunk, quiet = TRUE))
    
    cat("\n\n")
    
    # Add summary
    cat("### Subpopulation Summary\n\n")
    cat("```\n")
    cat(params$individual_summaries[[i]])
    cat("\n```\n\n")
    
    cat("<hr>\n\n")
  }
} else {
  cat("No individual results were generated or available for the report.\n")
}